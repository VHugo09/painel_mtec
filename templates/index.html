<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Painel de Pedidos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body {
            padding-left: 200px;
            padding-bottom: 100px;
            padding-top: 50px;
            padding-right: 200px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #333;
            color: white;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .tabela-container {
            overflow-x: auto;
            max-height: 400px;
        }
    </style>
</head>

<body class="bg-light">
    <div class="container mt-5">
        <h1 class="mb-4">üìä Painel de Pedidos</h1>
        <div class="d-flex justify-content-between align-items-center mb-3">
            <button class="btn btn-primary" onclick="abrirAdicionarModal()">
                Adicionar Novo Pedido
            </button>
            <a href="/logout" class="btn btn-danger">Sair</a>
        </div>
        <div class="tabela-container">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>OP/PV</th>
                        <th>Equipamento</th>
                        <th>Quantidade</th>
                        <th>Servi√ßo</th>
                        <th>Imagem</th>
                        <th>Status</th>
                        <th>Criado por</th>
                        <th>Data Cria√ß√£o</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="tabelaPedidos">
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal fade" id="editarModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="formEditarPedido">
                    <div class="modal-header">
                        <h5 class="modal-title">Editar Pedido</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="editId">
                        <div class="mb-3">
                            <label class="form-label">OP/PV</label>
                            <input type="text" id="editPv" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Equipamento</label>
                            <input type="text" id="editEquipamento" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Quantidade</label>
                            <input type="number" id="editQuantidade" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Servi√ßo</label>
                            <input type="text" id="editServico" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Imagem</label>
                            <select id="editImagemId" class="form-select" required>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select id="editStatusId" class="form-select" required>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="adicionarModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="formAdicionarPedido">
                    <div class="modal-header">
                        <h5 class="modal-title">Adicionar Novo Pedido</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">OP/PV</label>
                            <input type="text" id="addPv" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Equipamento</label>
                            <input type="text" id="addEquipamento" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Quantidade</label>
                            <input type="number" id="addQuantidade" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Servi√ßo</label>
                            <input type="text" id="addServico" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Imagem</label>
                            <select id="addImagemId" class="form-select" required>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select id="addStatusId" class="form-select" required>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Adicionar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let listaStatus = [];
        let listaImagem = [];

        async function carregarStatus() {
            let resp = await fetch("/status");
            listaStatus = await resp.json();
            // Preenche o dropdown de editar
            let selectStatusEdit = document.getElementById("editStatusId");
            selectStatusEdit.innerHTML = "";
            listaStatus.forEach(status => {
                let option = document.createElement("option");
                option.value = status.id;
                option.textContent = status.nome;
                selectStatusEdit.appendChild(option);
            });
            // Preenche o dropdown de adicionar
            let selectStatusAdd = document.getElementById("addStatusId");
            selectStatusAdd.innerHTML = "";
            listaStatus.forEach(status => {
                let option = document.createElement("option");
                option.value = status.id;
                option.textContent = status.nome;
                selectStatusAdd.appendChild(option);
            });
        }

        async function carregarImagem() {
            let resp = await fetch("/imagem");
            listaImagem = await resp.json();
            // Preenche o dropdown de editar
            let selectImagemEdit = document.getElementById("editImagemId");
            selectImagemEdit.innerHTML = "";
            listaImagem.forEach(imagem => {
                let option = document.createElement("option");
                option.value = imagem.id;
                option.textContent = imagem.nome;
                selectImagemEdit.appendChild(option);
            });
            // Preenche o dropdown de adicionar
            let selectImagemAdd = document.getElementById("addImagemId");
            selectImagemAdd.innerHTML = "";
            listaImagem.forEach(imagem => {
                let option = document.createElement("option");
                option.value = imagem.id;
                option.textContent = imagem.nome;
                selectImagemAdd.appendChild(option);
            });
        }

        async function carregarPedidos() {
            let resp = await fetch("/pedidos");
            let pedidos = await resp.json();

            let tbody = document.getElementById("tabelaPedidos");
            tbody.innerHTML = "";

            pedidos.forEach(p => {
                const imagemNome = p.imagem_nome ?? 'N/A';
                const statusNome = p.status ?? 'N/A';
                const imagemId = p.imagem_id ?? '';
                const statusId = p.status_id ?? '';
                // Formata a data para um formato mais leg√≠vel
                const dataCriacao = p.data_criacao ? new Date(p.data_criacao).toLocaleString('pt-BR') : 'N/A';
                const perfilAlteracao = p.perfil_alteracao ?? 'N/A';

                let tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${p.pv}</td>
                    <td>${p.equipamento}</td>
                    <td>${p.quantidade}</td>
                    <td>${p.descricao_servico}</td>
                    <td>${imagemNome}</td>
                    <td>${statusNome}</td>
                    <td>${perfilAlteracao}</td>
                    <td>${dataCriacao}</td>
                    <td>
                        <button class="btn btn-warning btn-sm"
                            onclick="editarPedido(${p.id}, '${p.pv}', '${p.equipamento}', ${p.quantidade}, '${p.descricao_servico}', ${imagemId}, ${statusId})">
                            Editar
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deletarPedido(${p.id})">Excluir</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function editarPedido(id, pv, equipamento, quantidade, servico, imagemId, statusId) {
            document.getElementById("editId").value = id;
            document.getElementById("editPv").value = pv;
            document.getElementById("editEquipamento").value = equipamento;
            document.getElementById("editQuantidade").value = quantidade;
            document.getElementById("editServico").value = servico;
            document.getElementById("editStatusId").value = statusId;
            document.getElementById("editImagemId").value = imagemId;

            let modal = new bootstrap.Modal(document.getElementById("editarModal"));
            modal.show();
        }

        async function deletarPedido(id) {
            if (confirm("Deseja realmente excluir este pedido?")) {
                await fetch(`/pedidos/${id}`, { method: "DELETE" });
                carregarPedidos();
            }
        }

        // Fun√ß√µes para a nova funcionalidade de adicionar
        function abrirAdicionarModal() {
            document.getElementById("formAdicionarPedido").reset(); // Limpa o formul√°rio
            let modal = new bootstrap.Modal(document.getElementById("adicionarModal"));
            modal.show();
        }

        document.getElementById("formAdicionarPedido").addEventListener("submit", async (e) => {
            e.preventDefault();

            let pv = document.getElementById("addPv").value;
            let equipamento = document.getElementById("addEquipamento").value;
            let quantidade = document.getElementById("addQuantidade").value;
            let servico = document.getElementById("addServico").value;
            let imagemId = document.getElementById("addImagemId").value;
            let statusId = document.getElementById("addStatusId").value;

            await fetch("/pedidos", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ pv, equipamento, quantidade, descricao_servico: servico, imagem_id: imagemId, status_id: statusId })
            });

            bootstrap.Modal.getInstance(document.getElementById("adicionarModal")).hide();
            carregarPedidos();
        });

        document.getElementById("formEditarPedido").addEventListener("submit", async (e) => {
            e.preventDefault();

            let id = document.getElementById("editId").value;
            let pv = document.getElementById("editPv").value;
            let equipamento = document.getElementById("editEquipamento").value;
            let quantidade = document.getElementById("editQuantidade").value;
            let servico = document.getElementById("editServico").value;
            let statusId = document.getElementById("editStatusId").value;
            let imagemId = document.getElementById("editImagemId").value;

            await fetch(`/pedidos/${id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ pv, equipamento, quantidade, descricao_servico: servico, status_id: statusId, imagem_id: imagemId })
            });

            bootstrap.Modal.getInstance(document.getElementById("editarModal")).hide();
            carregarPedidos();
        });

        document.addEventListener("DOMContentLoaded", async () => {
            await carregarStatus();
            await carregarImagem();
            await carregarPedidos();
        });
    </script>
</body>

</html>